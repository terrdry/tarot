---
creation date: 2025-05-24 16:26
date: 2025-05-24T00:00:00Z
modification date: 2025-05-24 16:26
tags: null
title: null
type: document
---

# Vagrant - Molecule Integration
## Intro

Despite reviewing extensive documentation, running various queries, and using AI tools, it took a considerable amount of time to figure out the exact conditions causing the issue. AI tools weren't particularly effective in identifying the problem or providing actionable insights.

I had hoped to read files from my system, get a clear understanding of what was happening, and have the AI suggest missing components or necessary files based on my goals. However, the guidance I received was minimal, mostly limited to basic installation instructions.

Technical documentation often assumes a certain level of expertise, which I lacked in this case. I had to fill in many gaps myself, which was frustrating and time-consuming. This highlights a common issue: the lack of comprehensive examples or fully configured setups in documentation. Without these, it's difficult to understand what’s possible or how to proceed.

Another challenge was the abundance of examples tailored for VirtualBox, which isn’t supported on my M2 Mac. I had to use VMware’s free version instead, but there’s limited information available for this setup. I wanted to address this gap and provide clearer guidance for others in similar situations.

With that said, let’s dive into the details.

### Role Creation

```sh
ansible-galaxy role init <<ROLENAME>>
```

This will create the normal role directory with all it's necessary files:

## Molecule Integration

As seen before in our infrastructure mapping; each subdirectory of /roles/\*\*/**molecule** coincides with a scenario the programmer  defined by the programmer;  in this case it is *molecule under the ntp role*

```sh
infrastructure/ansible
├── group_vars
├── inventories
│   ├── dev
│   │   ├── group_vars
│   │   └── host_vars
│   ├── prod
│   │   ├── group_vars
│   │   └── host_vars
│   └── qa
│       ├── group_vars
│       └── host_vars
├── playbooks
└── roles
    └── ntp        <--------- THE ROLE
        ├── defaults
        ├── handlers
        ├── meta
        ├── molecule        <---- Starting point for this role
        │   └── default     <---- Scenario Default
		│   └── new_account <-----2nd scenario, etc. etc.
		│   └── delete_account
├── playbooks
        ├── tasks
        ├── templates
        ├── tests
        └── vars
```

### Create Scenario

In our example. A scenario is created under the testing role's molecule directory
tree infrastructure/ansible  -d -A -I ".venv" -I instance

```sh
cd ansible/roles/<ROLE>
tree infrastructure/ansible  -d -A -I ".venv" -I instance
```

Each scenario will have the following structure.

```sh
.
├── defaults
├── files
├── handlers
├── meta
├── tasks
├── templates
├── tests
└── vars
```

So we will need to create the molecule directory and create a scenario
it with the following:

```sh
mkdir molecule
cd molecule
molecule init scenario <<SCENARIO_NAME>
```

The files created from that command in the <<SCENARIO_NAME>>

```sh
├── converge.yml
├── create.yml
├── destroy.yml
└── molecule.yml
```

### converge

This is the playbook that will run what is being developed at the time

```yaml
---
- name: Converge
  hosts: all
  gather_facts: false
  tasks:
    - name: Replace this task with one that validates your content
      ansible.builtin.debug:
        msg: "This is the effective test"
```

Merely replace the task with an include of your role that is being developed

### create

This is the create WHEN it gets generated by Molecule;

```yaml
---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: false
  # no_log: "{{ molecule_no_log }}"
  tasks:
    # TODO: Developer must implement and populate 'server' variable

    - name: Create instance config
      when: server.changed | default(false) | bool  # noqa no-handler
      block:
        - name: Populate instance config dict  # noqa jinja
          ansible.builtin.set_fact:
            instance_conf_dict: {}
            # instance': "{{ }}",
            # address': "{{ }}",
            # user': "{{ }}",
            # port': "{{ }}",
            # 'identity_file': "{{ }}", }
          with_items: "{{ server.results }}"
          register: instance_config_dict

        - name: Convert instance config dict to a list
          ansible.builtin.set_fact:
            instance_conf: "{{ instance_config_dict.results | map(attribute='ansible_facts.instance_conf_dict') | list }}"

        - name: Dump instance config
          ansible.builtin.copy:
            content: |
              # Molecule managed

              {{ instance_conf | to_json | from_json | to_yaml }}
            dest: "{{ molecule_instance_config }}"
            mode: "0600"
```

It is **your responsibility to define and add** the Create molecule instance (see TODO above)

Modify the Create instance config by activating the commented out code

```yaml
- name: Create molecule instance(s) # noqa fqcn[action]
    vagrant:
      instances: "{{ molecule_yml.platforms }}"
      default_box: "{{ molecule_yml.driver.default_box | default('generic/alpine316') }}"
      provider_name: "{{ molecule_yml.driver.provider.name | default(omit, true) }}"
      provision: "{{ molecule_yml.driver.provision | default(omit) }}"
      cachier: "{{ molecule_yml.driver.cachier | default(omit) }}"
      parallel: "{{ molecule_yml.driver.parallel | default(omit) }}"
      state: up
    register: server
```

We have the same issue with the destroy command

### destroy

This action is almost identical to what was done for create. The delete playbook has to have the instancce being deleted

```yaml
---
- name: Destroy
  hosts: localhost
  connection: local
  gather_facts: false
  # no_log: "{{ molecule_no_log }}"
  tasks:
    # Developer must implement.
								#<--- MUST BE IMPLEMENTED
    # Mandatory configuration for Molecule to function.

    - name: Populate instance config
      ansible.builtin.set_fact:
        instance_conf: {}

    - name: Dump instance config
      ansible.builtin.copy:
        content: |
          # Molecule managed

          {{ instance_conf | to_json | from_json | to_yaml }}
        dest: "{{ molecule_instance_config }}"
        mode: "0600"
      when: server.changed | default(false) | bool  # noqa no-handler
```

the modified task is:

```yaml
    - name: Destroy molecule instance(s)
      vagrant:
        instances: "{{ molecule_yml.platforms }}"
        default_box: "{{ molecule_yml.driver.default_box | default('generic/alpine316') }}"
        provider_name: "{{ molecule_yml.driver.provider.name | default(omit, true) }}"
        cachier: "{{ molecule_yml.driver.cachier | default(omit) }}"
        force_stop: "{{ item.force_stop | default(true) }}"
        state: destroy
      register: server
```

### molecule.yml

The molecule file is in essence a configuration file for molecule.

```yaml
driver:
  name: vagrant
  provider:
    name: vmware_desktop

platforms:
  - name: nomad
    box: tknerr/ubuntu2004-desktop
    memory: 2048  # Memory allocated to the instance in MB
    # Number of virtual CPUs allocated to the instance
    cpus: 2
provisioner:
  name: ansible
  config_options:
    defaults:
      # library: ${workspaceFolder}:".venv/lib/python3.13/site_packages"
      #library: "{{ lookup('env', 'LIBRARY_PATH') }}"
      library: //Users/terrydrymonacos//develop/tarot/.venv/lib/python3.13/site-packages
      # Dynamically sets the library path from the environment variable `LIBRARY_PATH`
      # library: "{{ lookup('env', 'LIBRARY_PATH') }}"

```

This file is using the __vagrant__ driver and the provider name of __vmware_desktop__

```yaml
driver:
  name: vagrant
  provider:
    name: vmware_desktop
```

A temporary directory is created for every run in the ~/.ansible/tmp/molecule.\_WZi.<<scenario_name>>

There you will see the output of the vagrant by looking at the Vagrantfile generated from the above paragraph upon running **molecule create**

```ruby
Vagrant.configure('2') do |config|
  if Vagrant.has_plugin?('vagrant-cachier')
    config.cache.scope = 'machine'
  end
  config.vm.define "nomad" do |c|
    ##
    # Box definition
    ##
    c.vm.box = "tknerr/ubuntu2004-desktop"
    ##
    # Config options
    ##
    c.vm.synced_folder ".", "/vagrant", disabled: true
    c.ssh.insert_key = true
    c.vm.hostname = "nomad"
    ##
    # Network
    ##
    ##
    # instance_raw_config_args
    ##
    ##
    # Provider
    ##
    c.vm.provider "vmware_desktop" do |vmware_desktop, override|
      vmware_desktop.vmx['memsize'] = 2048
      vmware_desktop.vmx['numvcpus'] = 2
    end
  end
end
```

There is ansible.cfg file that is used by the molecule test in progress; you may have to add more configuration options in your molecule.yml file. For instance in this case the library directory be included in the molecule/default/ directory

Notice the provisioner's library contents and how they connect with the molecule generated ansible.cfg

provisioner:
  name: ansible
  config_options:
    defaults
      library: //Users/terrydrymonacos//develop/tarot/.venv/lib/python3.13/site-packages


cat ansible.cfg
# Molecule managed

[defaults]
ansible_managed = Ansible managed: Do NOT edit this file manually!
display_failed_stderr = True
forks = 50
retry_files_enabled = False
host_key_checking = False
nocows = 1
interpreter_python = auto_silent
library = //Users/terrydrymonacos//develop/tarot/.venv/lib/python3.13/site-packages  #--->
[ssh_connection]
scp_if_ssh = True
control_path = %(directory)s/%%h-%%p-%%r

See if it is properly registered and This will show you the scenarios installed

```sh
molecule list
```

## Putting it all together

### Testing

```sh
# goto the directory that your role is in
molecule test -s <SCENARIO_NAME>
```

### Create your vagrant and test it

```sh
molecule create -s <<SCENARIO_NAME>>
cd molecule/<<SCENARIO_NAME>>
vagrant up
```

### Development

```sh
molecule converge -s <<SCENARIO_NAME>>
```

## Key Testing Principles:

1. **Isolation**: Each test runs in its own Vagrant VM
2. **Idempotency**: Tests should be repeatable
3. **Cleanup**: Resources should be properly destroyed after testing
4. **Integration**: Test actual infrastructure changes
5. **Verification**: Validate the expected state

## Debugging Tips:

1. Use `vagrant ssh` to inspect the VM state
2. Check logs in `.kitchen/logs/` for Terraform
3. Use `molecule login` for Ansible testing
4. Enable verbose output with `ANSIBLE_VERBOSE=true`
5. Debug Mode: Run `molecule --debug converge` to get detailed output and identify any errors during the execution.
6. Check Logs:** Examine the output and any log files for error messages related to Vagrant or Molecule.
7. **`molecule reset`:** If you have made changes to your Molecule configuration, try running `molecule reset` to clear any cached data and ensure the new configuration is applied.Remember to add `.vagrant/`

## Functionable output

```sh
  molecule test -s default
WARNING  Driver vagrant does not provide a schema.
INFO     default scenario test matrix: dependency, cleanup, destroy, syntax, create, prepare, converge, idempotence, side_effect, verify, cleanup, destroy
INFO     Performing prerun with role_name_check=0...
INFO     Running default > dependency
WARNING  Skipping, missing the requirements file.
WARNING  Skipping, missing the requirements file.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Destroy molecule instance(s)] ********************************************
ok: [localhost]

TASK [Populate instance config] ************************************************
ok: [localhost]

TASK [Dump instance config] ****************************************************
skipping: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

INFO     Running default > syntax

playbook: /Users/terrydrymonacos/develop/tarot/infrastructure/ansible/roles/ntp/molecule/default/converge.yml
INFO     Running default > create

PLAY [Create] ******************************************************************

TASK [Create molecule instance(s)] *********************************************
changed: [localhost]

TASK [Populate instance config dict] *******************************************
ok: [localhost] => (item={'Host': 'nomad', 'HostName': '127.0.0.1', 'User': 'vagrant', 'Port': '2222', 'UserKnownHostsFile': '/dev/null', 'StrictHostKeyChecking': 'no', 'PasswordAuthentication': 'no', 'IdentityFile': '/Users/terrydrymonacos/.ansible/tmp/molecule._WZi.default/.vagrant/machines/nomad/vmware_desktop/private_key', 'IdentitiesOnly': 'yes', 'LogLevel': 'FATAL', 'PubkeyAcceptedKeyTypes': '+ssh-rsa', 'HostKeyAlgorithms': '+ssh-rsa'})

TASK [Convert instance config dict to a list] **********************************
ok: [localhost]

TASK [Dump instance config] ****************************************************
changed: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > prepare
[WARNING]: Found variable using reserved name: connection

PLAY [Prepare] *****************************************************************

TASK [Bootstrap python for Ansible] ********************************************
ok: [nomad]

PLAY RECAP *********************************************************************
nomad                      : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > converge
[WARNING]: Found variable using reserved name: connection

PLAY [Converge] ****************************************************************

TASK [Replace this task with one that validates your content] ******************
ok: [nomad] => {
    "msg": "This is the effective test"
}

PLAY RECAP *********************************************************************
nomad                      : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > idempotence
[WARNING]: Found variable using reserved name: connection

PLAY [Converge] ****************************************************************

TASK [Replace this task with one that validates your content] ******************
ok: [nomad] => {
    "msg": "This is the effective test"
}

PLAY RECAP *********************************************************************
nomad                      : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Idempotence completed successfully.
INFO     Running default > side_effect
WARNING  Skipping, side effect playbook not configured.
INFO     Running default > verify
INFO     Running Ansible Verifier
WARNING  Skipping, verify playbook not configured.
INFO     Verifier completed successfully.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Destroy molecule instance(s)] ********************************************
changed: [localhost]

TASK [Populate instance config] ************************************************
ok: [localhost]

TASK [Dump instance config] ****************************************************
changed: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Pruning extra files from scenario ephemeral directory
```
